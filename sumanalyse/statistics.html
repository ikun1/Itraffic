<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Hello OpenCV.js</title>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/britecharts/dist/css/britecharts.min.css"
        type="text/css" />
    <link rel="stylesheet" href="css/scatter.css">
    <!-- 引入组件库 -->
    <style>
        .el-header,
        .el-footer {
            background-color: #B3C0D1;
            color: #333;
            text-align: center;
            line-height: 60px;
        }

        .el-aside {
            background-color: #D3DCE6;
            color: #333;
            text-align: center;
            line-height: 200px;
        }

        .el-main {
            background-color: #E9EEF3;
            color: #333;
        }

        body>.el-container {
            margin-bottom: 40px;
        }

        .text {
            font-size: 14px;
        }

        .item {
            margin-bottom: 18px;
        }

        .clearfix:before,
        .clearfix:after {
            display: table;
            content: "";
        }

        .clearfix:after {
            clear: both
        }

        .box-card {
            width: 480px;
        }

        .text.item {
            text-align: left;
        }

        .avatar-uploader .el-upload {
            border: 1px dashed #d9d9d9;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .avatar-uploader .el-upload:hover {
            border-color: #409EFF;
        }

        .avatar-uploader-icon {
            font-size: 28px;
            color: #8c939d;
            width: 375px;
            height: 375px;
            line-height: 178px;
            text-align: center;
        }

        .avatar {
            width: 375px;
            height: 375px;
            display: block;
        }
    </style>
</head>

<body>
    <div id="app">
        <el-container style="height: 700p">
            <el-aside width="200px">
                <el-menu :default-openeds="['1']" @select="handleSelect">
                    <el-submenu index="1">
                        <template slot="title"><i class="el-icon-message"></i>出行分析</template>
                        <el-menu-item-group>
                            <el-menu-item index="1-1">出行方式与路段</el-menu-item>
                        </el-menu-item-group>
                    </el-submenu>
                    <el-submenu index="2">
                        <template slot="title"><i class="el-icon-menu"></i>密度分析</template>
                        <el-menu-item-group>
                            <el-menu-item index="2-1">区域密度</el-menu-item>
                        </el-menu-item-group>
                    </el-submenu>
                    <el-submenu index="3">
                        <template slot="title"><i class="el-icon-setting"></i>驻点分析</template>
                        <el-menu-item-group>
                            <el-menu-item index="3-1">驻点及商圈</el-menu-item>
                        </el-menu-item-group>
                    </el-submenu>
                    <el-submenu index="4">
                        <template slot="title"><i class="el-icon-setting"></i>实验四</template>
                        <el-menu-item-group>
                            <template slot="title">分组一</template>
                            <el-menu-item index="3-1">选项1</el-menu-item>
                            <el-menu-item index="3-2">选项2</el-menu-item>
                        </el-menu-item-group>
                        <el-menu-item-group title="分组2">
                            <el-menu-item index="3-3">选项3</el-menu-item>
                        </el-menu-item-group>
                        <el-submenu index="3-4">
                            <template slot="title">选项4</template>
                            <el-menu-item index="3-4-1">选项4-1</el-menu-item>
                        </el-submenu>
                    </el-submenu>
                </el-menu>
            </el-aside>
            <el-container>
                <el-header>Header</el-header>
                <el-main>
                    <div v-show="chosenIndex=='1-1'">
                        <div class="roadScatter">
                        </div>
                        <el-row :gutter="20">
                            <el-col :span="5">
                                <div class="pieChart"></div>
                            </el-col>
                            <el-col :span="5">
                                <div class="donutChart"></div>
                            </el-col>
                            <el-col :span="5">
                                <div class="barchart"></div>
                            </el-col>
                            <el-col :span="9">
                                <div class="bartimechart"></div>
                            </el-col>
                        </el-row>
                        <div class="stackchart">
                        </div>
                    </div>
                    <div v-show="chosenIndex=='2-1'">
                        <el-row :gutter="20">
                            <el-col :span="13">
                                <div class="partmap"></div>
                            </el-col>
                            <el-col :span="11">
                                <div class="density" style="height: 280px;">
                                    <p class="title chinese">所选区：</p>
                                    <p class="text chinese " id="district"></p>
                                    <p class="title chinese">总流量：</p>
                                    <p class="text chinese " id="trans"></p>
                                    <p class="title chinese road">热门路段：</p>
                                    <div class="text chinese" id="road"></div>
                                </div>
                                <div class="densityline"></div>
                            </el-col>
                        </el-row>
                    </div>
                    <div v-show="chosenIndex=='3-1'">
                        <el-row :gutter="20">
                            <el-col :span="13">
                                <div class="staymap"></div>
                            </el-col>
                            <el-col :span="11">
                                <div class="staypointtext" style="height: 280px;">
                                    所选驻点:<p class="text chinese " id="point"></p>
                                    驻点频率:<p class="text chinese " id="frequency"></p>
                                    驻留时间:<p class="text chinese" id="time"></p>
                                    所在商圈:<p class="text chinese" id="business"></p>
                                </div>
                                <div class="business"></div>
                            </el-col>
                        </el-row>
                    </div>
                </el-main>
            </el-container>
        </el-container>
    </div>
    <!-- import Vue before Element -->
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="legend.js"></script>

    <script type="text/javascript">
        new Vue({
            el: '#app',
            data: function () {
                return {
                    visible: false,
                    imageUrl: '',
                    chosenIndex: ''
                }
            },
            methods: {
                handleSelect: function (key, keyPath) {
                    this.chosenIndex = key;

                    console.log(key, keyPath)
                },
                handleAvatarSuccess(res, file) {
                    this.imageUrl = URL.createObjectURL(file.raw);
                }
            }
        })

        //绘制路段分析的散点图

        //可视分析界面1
        d3.json("time15.json").then(function (data) {
            var piedata = [
                { name: '机动车', value: 0 },
                { name: '步行及骑行', value: 0 },
                { name: '公共交通', value: 0 }
            ];
            var donutdata = [
                { name: '公交', value: 0 },
                { name: '地铁', value: 0 },
                { name: '驾车', value: 0 },
                { name: '骑行', value: 0 },
                { name: '步行', value: 0 }
            ];
            var timedata = []
            var districtSum = []
            var districtMap = new Map();
            //初始化饼图与环形图的数据
            for (let key in data) {
                for (let district in data[key]) {
                    if (!districtMap.has(district)) {
                        districtMap[district] = 0;
                    }
                    let sum = 0;
                    for (let way in data[key][district]) {
                        if (way == '公交') {
                            piedata[2]['value'] += data[key][district][way]
                            donutdata[0]['value'] += data[key][district][way]
                            sum += data[key][district][way]
                        } else if (way == '地铁') {
                            piedata[2]['value'] += data[key][district][way]
                            donutdata[1]['value'] += data[key][district][way]
                            sum += data[key][district][way]
                        } else if (way == '驾车') {
                            piedata[0]['value'] += data[key][district][way]
                            donutdata[2]['value'] += data[key][district][way]
                            sum += data[key][district][way]
                        } else if (way == '骑行') {
                            piedata[1]['value'] += data[key][district][way]
                            donutdata[3]['value'] += data[key][district][way]
                            sum += data[key][district][way]
                        } else if (way == '步行') {
                            piedata[1]['value'] += data[key][district][way]
                            donutdata[4]['value'] += data[key][district][way]
                            sum += data[key][district][way]
                        }
                    }
                    districtMap[district] += sum;
                }
            }
            //初始化各个区的交通数据
            for (let key in districtMap) {
                districtSum.push({
                    name: key,
                    sum: districtMap[key]
                })
            }
            districtSum.sort((a, b) => b.sum - a.sum)
            let time = 8
            while (time) {
                districtSum.pop();
                time--;
            }
            //初始化各个时间段的交通数据
            for (let key in data) {
                let index = timedata.length;
                timedata.push({
                    name: key,
                    '公交': 0,
                    '地铁': 0,
                    '驾车': 0,
                    '骑行': 0,
                    '步行': 0,
                    sum: 0
                })
                for (let district in data[key]) {
                    for (let way in data[key][district]) {
                        timedata[index][way] += data[key][district][way]
                    }
                }
                timedata[index]['sum'] = timedata[index]['公交'] + timedata[index]['地铁'] + timedata[index]['驾车'] + timedata[index]['骑行'] + timedata[index]['步行']
            }
            //绘制饼图
            let width = 260;
            let height = 260;
            let pie = d3.pie()
                .sort(null)
                .value(d => d.value)
            let arcs = pie(piedata);
            let piecolor = d3.scaleOrdinal()
                .domain(piedata.map(d => d.name))
                .range(d3.schemeBlues[3]);
            let piearc = d3.arc()
                .innerRadius(0)
                .outerRadius(Math.min(width, height) / 2 - 1)
            let radius = Math.min(width, height) / 2 * 0.8;


            let svgPie = d3.select(".pieChart").append("svg")
                .attr("viewBox", [-width / 2, -height / 2, width, height]);

            svgPie.append("g")
                .attr("stroke", "white")
                .attr("class", "pie")
                .selectAll("path")
                .data(arcs)
                .join("path")
                .attr("fill", d => piecolor(d.data.name))
                .attr("d", piearc)
                .append("title")
                .text(d => `${d.data.name}: ${d.data.value.toLocaleString()}`);

            svgPie.append("g")
                .attr("font-family", "sans-serif")
                .attr("font-size", 12)
                .attr("text-anchor", "middle")
                .selectAll("text")
                .data(arcs)
                .join("text")
                .attr("transform", d => `translate(${d3.arc().innerRadius(radius).outerRadius(radius).centroid(d)})`)
                .call(text => text.append("tspan")
                    .attr("class", "name")
                    .attr("y", "-0.4em")
                    .attr("font-weight", "bold")
                    .text(d => d.data.name))
                .call(text => text.filter(d => (d.endAngle - d.startAngle) > 0.25).append("tspan")
                    .attr("class", "value")
                    .attr("x", 0)
                    .attr("y", "0.7em")
                    .attr("fill-opacity", 0.7)
                    .text(d => d.data.value.toLocaleString()));

            //绘制环形图
            let donutpie = d3.pie()
                .padAngle(0.005)
                .sort(null)
                .value(d => d.value)
            const donutradius = Math.min(width, height) / 2;
            let arc = d3.arc().innerRadius(donutradius * 0.5).outerRadius(donutradius - 1);
            let color = d3.scaleOrdinal()
                .domain(donutdata.map(d => d.name))
                .range(d3.schemeBlues[5])
            const donutarcs = donutpie(donutdata);

            let svg = d3.select(".donutChart").append("svg")
                .attr("viewBox", [-width / 2, -height / 2, width, height]);

            svg.selectAll("path")
                .data(donutarcs)
                .join("path")
                .attr("fill", d => color(d.data.name))
                .attr("d", arc)
                .append("title")
                .text(d => `${d.data.name}: ${d.data.value.toLocaleString()}`);

            svg.append("g")
                .attr("font-family", "sans-serif")
                .attr("font-size", 12)
                .attr("text-anchor", "middle")
                .selectAll("text")
                .data(donutarcs)
                .join("text")
                .attr("transform", d => `translate(${arc.centroid(d)})`)
                .call(text => text.append("tspan")
                    .attr("class", "name")
                    .attr("y", "-0.4em")
                    .attr("font-weight", "bold")
                    .text(d => d.data.name))
                .call(text => text.filter(d => (d.endAngle - d.startAngle) > 0.25).append("tspan")
                    .attr("class", "value")
                    .attr("x", 0)
                    .attr("y", "0.7em")
                    .attr("fill-opacity", 0.7)
                    .text(d => d.data.value.toLocaleString()));

            //绘制条形图
            let barHeight = 25
            let margin = ({ top: 30, right: 0, bottom: 10, left: 30 })

            let barcolor = d3.scaleOrdinal()
                .domain(districtSum.map(d => d.name))
                .range(d3.schemeBlues[9])

            let sumsvg = d3.select(".barchart").append("svg")
                .attr("viewBox", [0, 0, width, height]);
            let xsum = d3.scaleLinear()
                .domain([0, d3.max(districtSum, d => d.sum)])
                .range([margin.left, width - margin.right])
            let ysum = d3.scaleBand()
                .domain(d3.range(districtSum.length))
                .rangeRound([margin.top, height - margin.bottom])
                .padding(0.1)

            let xAxissum = g => g
                .attr("transform", `translate(0,${margin.top})`)
                .call(d3.axisTop(xsum).ticks(5))
                .call(g => g.select(".domain").remove())

            let yAxissum = g => g
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(ysum).tickFormat(i => districtSum[i].name).tickSizeOuter(0))
                .call(g => g.selectAll("text").remove())

            sumsvg.append("g")
                .selectAll("rect")
                .data(districtSum)
                .join("rect")
                .attr("x", xsum(0))
                .attr("y", (d, i) => ysum(i))
                .attr("fill", d => barcolor(d.name))
                .attr("width", d => xsum(d.sum) - xsum(0))
                .attr("height", ysum.bandwidth());

            sumsvg.append("g")
                .attr("fill", "black")
                .attr("text-anchor", "end")
                .attr("font-family", "sans-serif")
                .attr("font-size", 12)
                .selectAll("text")
                .data(districtSum)
                .join("text")
                .attr("x", d => xsum(d.sum))
                .attr("y", (d, i) => ysum(i) + ysum.bandwidth() / 2)
                .attr("dy", "0.35em")
                .attr("dx", -4)
                .text(d => d.name)
                .call(text => text.filter(d => xsum(d.sum) - xsum(0) < 20) // short bars
                    .attr("dx", +4)
                    .attr("fill", "black")
                    .attr("text-anchor", "start"));

            sumsvg.append("g")
                .call(xAxissum);

            sumsvg.append("g")
                .call(yAxissum);

            //绘制各个时间段的条形图
            let bartimewidth = 520
            const bartimesvg = d3.select(".bartimechart").append("svg")
                .attr("viewBox", [0, 0, bartimewidth, height]);
            let bartimex = d3.scaleBand()
                .domain(d3.range(timedata.length))
                .range([margin.left, bartimewidth - margin.right])
                .padding(0.1)

            let bartimey = d3.scaleLinear()
                .domain([0, d3.max(timedata, d => d.sum)]).nice()
                .range([height - margin.bottom - 10, margin.top])
            let xAxisbartime = g => g
                .attr("transform", `translate(0,${height - margin.bottom - 10})`)
                .call(d3.axisBottom(bartimex).tickFormat(i => timedata[i].name).tickSizeOuter(0))
            let yAxisbartime = g => g
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(bartimey).ticks(null, timedata.format))
                .call(g => g.select(".domain").remove())
                .call(g => g.append("text")
                    .attr("x", -margin.left)
                    .attr("y", 10)
                    .attr("fill", "currentColor")
                    .attr("text-anchor", "start")
                    .text(timedata.name))

            bartimesvg.append("g")
                .attr("fill", "steelblue")
                .selectAll("rect")
                .data(timedata)
                .join("rect")
                .attr("x", (d, i) => bartimex(i))
                .attr("y", d => bartimey(d.sum))
                .attr("height", d => bartimey(0) - bartimey(d.sum))
                .attr("width", bartimex.bandwidth());

            bartimesvg.append("g")
                .call(xAxisbartime);

            bartimesvg.append("g")
                .call(yAxisbartime);

            // 绘制堆栈图
            console.log(timedata)
            let stackwidth = 1280;
            let stackheight = 320;
            let stackdata = []
            for (let key in data) {
                let curobj = {}
                curobj.name = key
                for (let district in data[key]) {
                    curobj[district] = data[key][district]['公交'] + data[key][district]['地铁'] + data[key][district]['驾车'] + data[key][district]['骑行'] + data[key][district]['步行']
                }
                stackdata.push(curobj)
            }
            const stacksvg = d3.select(".stackchart").append("svg")
                .attr("viewBox", [0, 0, stackwidth, stackheight]);
            let districtlist = ["和平区", "沈河区", "大东区", "皇姑区", "铁西区", "苏家屯区", "浑南区", "沈北新区", "于洪区", "辽中区", "康平县", "法库县", "新民市"]
            let series = d3.stack().keys(districtlist)(stackdata)
            console.log(series)
            let stackx = d3.scaleBand()
                .domain(d3.range(stackdata.length + 1).slice(1))
                .range([margin.left, stackwidth - margin.right])
            let stacky = d3.scaleLinear()
                .domain([0, d3.max(series, d => d3.max(d, d => d[1]))])
                .range([stackheight - margin.bottom - 10, margin.top])
            console.log(stacky(0))
            let stackcolor = d3.scaleOrdinal()
                .domain(districtlist)
                .range(d3.schemePastel1)
            // let stackarea = d3.area()
            //     .x(d => stackx(parseInt(d.data.name)))
            //     .y0(d => stacky(d[0]))
            //     .y1(d => stacky(d[1]));
            //debug用的
            let stackarea = d3.area()
                .x(d => {
                    let a = stackx(parseInt(d.data.name))
                    debugger
                    return a
                })
                .y0(d => {
                    let b = stacky(d[0])
                    debugger
                    return b
                })
                .y1(d => stacky(d[1]));
            let xAxisStack = g => g
                .attr("transform", `translate(0,${stackheight - margin.bottom - 10})`)
                .call(d3.axisBottom(stackx).ticks(width / 80).tickSizeOuter(0))
            let yAxisStack = g => g
                .attr("class", "y")
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(stacky))
                .call(g => g.select(".domain").remove())

            stacksvg.append("g")
                .selectAll("path")
                .data(series)
                .join("path")
                .attr("fill", ({ key }) => stackcolor(key))
                .attr("d", stackarea)
                .on("click", function (d) {
                    console.log("click")
                    let thisType = d.key;
                    let thisTypeDataset = []
                    for (let key in data) {
                        let curobj = {}
                        curobj.name = key
                        for (let district in data[key]) {
                            if (district == thisType) {
                                curobj[district] = data[key][district]['公交'] + data[key][district]['地铁'] + data[key][district]['驾车'] + data[key][district]['骑行'] + data[key][district]['步行']
                                thisTypeDataset.push(curobj)
                            }
                        }
                    }
                    let thisTypeSeries = d3.stack().keys([thisType])(thisTypeDataset)
                    d3.selectAll(".stackchart path")
                        .transition(d3.transition()
                            .duration(1000)
                            .ease(d3.easeLinear))
                        .remove()
                    let paths = d3.selectAll(".stackchart path")
                        .data(thisTypeSeries)
                        .join("path");
                    console.log(thisTypeSeries)
                    // var areaTransitions = paths.transition()
                    //     .duration(1000)
                    //     .attr("d", stackarea);

                    stacky.domain([
                        0,
                        d3.max(thisTypeSeries, d => d3.max(d, d => d[1]))
                    ]);
                    console.log(stacky.domain())

                    paths.transition()
                        .delay(200)
                        .on("start", function () {
                            //Transition axis to new scale concurrently
                            // d3.select("g.axis.y")
                            // 	.transition()
                            // 	.duration(1000)
                            // 	.call(yAxis);
                            d3.select(".stackchart .y")
                                .transition()
                                .duration(1000)
                                .call(yAxisStack);

                        })
                        .duration(1000)
                        .attr("d", stackarea)
                        .transition()
                        .on("start", function () {
                            //Make vehicles visible instantly, so 
                            //they are revealed when this fades out
                            d3.selectAll(".stackchart path")
                                .attr("opacity", 1);
                        })
                        .duration(1000);

                    for (let key in piedata) {
                        piedata[key]['value'] = 0
                    }
                    for (let key in donutdata) {
                        donutdata[key]['value'] = 0
                    }
                    for (let key in data) {
                        for (let district in data[key]) {
                            if (district == thisType) {
                                if (!districtMap.has(district)) {
                                    districtMap[district] = 0;
                                }
                                let sum = 0;
                                for (let way in data[key][district]) {
                                    if (way == '公交') {
                                        piedata[2]['value'] += data[key][district][way]
                                        donutdata[0]['value'] += data[key][district][way]
                                        sum += data[key][district][way]
                                    } else if (way == '地铁') {
                                        piedata[2]['value'] += data[key][district][way]
                                        donutdata[1]['value'] += data[key][district][way]
                                        sum += data[key][district][way]
                                    } else if (way == '驾车') {
                                        piedata[0]['value'] += data[key][district][way]
                                        donutdata[2]['value'] += data[key][district][way]
                                        sum += data[key][district][way]
                                    } else if (way == '骑行') {
                                        piedata[1]['value'] += data[key][district][way]
                                        donutdata[3]['value'] += data[key][district][way]
                                        sum += data[key][district][way]
                                    } else if (way == '步行') {
                                        piedata[1]['value'] += data[key][district][way]
                                        donutdata[4]['value'] += data[key][district][way]
                                        sum += data[key][district][way]
                                    }
                                }
                                districtMap[district] += sum;
                            }
                        }
                    }
                    console.log(piedata)
                    let piesingle = d3.select(".pie")
                        .selectAll("path")
                        .data(pie(piedata))
                        .join("path")
                        .transition()
                        .delay(200)
                        .duration(1500)
                        .attr("d", piearc)

                    piesingle.selectAll("title")
                        .text(d => `${d.data.name}: ${d.data.value.toLocaleString()}`)

                    d3.select(".pieChart")
                        .selectAll("text")
                        .data(pie(piedata))
                        .join("text")
                        .transition()
                        .delay(200)
                        .duration(1500)
                        .attr("transform", d => `translate(${d3.arc().innerRadius(radius).outerRadius(radius).centroid(d)})`)
                        .call(text => text.selectAll(".name")
                            .attr("y", "-0.4em")
                            .attr("font-weight", "bold")
                            .text(d => d.data.name))
                        .call(text => text.filter(d => (d.endAngle - d.startAngle) > 0.25).selectAll(".value")
                            .attr("x", 0)
                            .attr("y", "0.7em")
                            .attr("fill-opacity", 0.7)
                            .text(d => d.data.value.toLocaleString()));


                    d3.selectAll(".donutChart path")
                        .data(donutpie(donutdata))
                        .join("path")
                        .transition()
                        .delay(200)
                        .duration(1500)
                        .attr("d", arc)
                        .selectAll("title")
                        .text(d => `${d.data.name}: ${d.data.value.toLocaleString()}`);

                    svg.selectAll(".donutChart text")
                        .data(donutpie(donutdata))
                        .join("text")
                        .transition()
                        .delay(200)
                        .duration(1500)
                        .attr("transform", d => `translate(${arc.centroid(d)})`)
                        .call(text => text.selectAll(".name")
                            .attr("y", "-0.4em")
                            .attr("font-weight", "bold")
                            .text(d => d.data.name))
                        .call(text => text.filter(d => (d.endAngle - d.startAngle) > 0.25).selectAll(".value")
                            .attr("x", 0)
                            .attr("y", "0.7em")
                            .attr("fill-opacity", 0.7)
                            .text(d => d.data.value.toLocaleString()));


                })
                .append("title")
                .text(({ key }) => key);

            stacksvg.append("g")
                .call(xAxisStack);

            stacksvg.append("g")
                .call(yAxisStack);

        })
        //可视界面1的热门路段的散点图
        d3.json("roadParse.json").then(function (data) {
            let locatemap = new Map();
            let locateobj = {}
            let scatterdata = []
            for (let key in data) {
                for (let pos in data[key]) {
                    if (!locatemap.has(pos)) {
                        locatemap[pos] = data[key][pos]['frequency'];
                        locateobj[pos] = {
                            lng: data[key][pos]['lng'],
                            lat: data[key][pos]['lat'],
                        }
                    } else {
                        locatemap[pos] += data[key][pos]['frequency'];
                    }
                }
            }
            for (let key in locatemap) {
                if (locatemap[key] > 2) {
                    let curobj = {};
                    curobj.name = key;
                    curobj.frequency = locatemap[key]
                    curobj.lat = locateobj[key]['lat']
                    curobj.lng = locateobj[key]['lng']
                    scatterdata.push(curobj)
                }

            }
            console.log(scatterdata)
            let bisectYear = d3.bisector(([year]) => year).left
            let margin = ({ top: 20, right: 20, bottom: 35, left: 40 })
            let height = 300;
            let width = 1200;
            let svgRoadScatter = d3.select(".roadScatter")
                .append("svg")
                //.style("height", "300px")
                .attr("viewBox", [0, 0, width, height]);

            let x = d3.scaleLinear()
                .domain([d3.min(scatterdata, d => d.lat), d3.max(scatterdata, d => d.lat)])
                .range([margin.left, width - margin.right]);
            let y = d3.scaleLinear()
                .domain([d3.min(scatterdata, d => d.lng), d3.max(scatterdata, d => d.lng)])
                .range([height - margin.bottom, margin.top]);
            let radius = d3.scaleSqrt([3, 8], [4, width / 24]);
            let color = d3.scaleOrdinal(scatterdata.map(d => d.name), d3.schemeCategory10).unknown("black");
            let xAxis = g => g
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(width / 80, ","))
                .call(g => g.selectAll("text").remove())
                .call(g => g.append("text")
                    .attr("x", width)
                    .attr("y", margin.bottom - 4)
                    .attr("fill", "currentColor")
                    .attr("text-anchor", "end")
                    .text("latitude/纬度 →"));

            let yAxis = g => g
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(y))
                .call(g => g.selectAll("text").remove())
                .call(g => g.append("text")
                    .attr("x", -margin.left)
                    .attr("y", 10)
                    .attr("fill", "currentColor")
                    .attr("text-anchor", "start")
                    .text("↑Longitude/经度"));

            let grid = g => g
                .attr("stroke", "currentColor")
                .attr("stroke-opacity", 0.1)
                .call(g => g.append("g")
                    .selectAll("line")
                    .data(x.ticks())
                    .join("line")
                    .attr("x1", d => 0.5 + x(d))
                    .attr("x2", d => 0.5 + x(d))
                    .attr("y1", margin.top)
                    .attr("y2", height - margin.bottom))
                .call(g => g.append("g")
                    .selectAll("line")
                    .data(y.ticks())
                    .join("line")
                    .attr("y1", d => 0.5 + y(d))
                    .attr("y2", d => 0.5 + y(d))
                    .attr("x1", margin.left)
                    .attr("x2", width - margin.right));

            svgRoadScatter.append("g")
                .call(xAxis);
            svgRoadScatter.append("g")
                .call(yAxis);
            svgRoadScatter.append("g")
                .call(grid);

            let roadCircle = svgRoadScatter.append("g")
                .attr("stroke", "black")
                .selectAll("circle")
                .data(scatterdata)
                .join("circle")
                .attr("cx", d => x(d.lat))
                .attr("cy", d => y(d.lng))
                .attr("r", d => radius(d.frequency))
                .attr("fill", d => color(d.name))
                .call(roadCircle => roadCircle.append("title")
                    .text(d => [d.name, d.lat, d.lng].join("\n")));

        })

        //绘制密度分布的地图
        d3.json("shenyang.json").then(function (data) {
            d3.json("district.json").then(function (districtdata) {
                //初始化保存每个区各个时段的对象
                let districtObj = {};
                for (let key in districtdata['1']) {
                    districtObj[key] = new Array(24);
                }
                console.log(districtObj)
                //为对象赋值
                for (var time in districtdata) {
                    let timeint = parseInt(time) - 1;
                    for (let dis in districtdata[time]) {
                        districtObj[dis][timeint] = districtdata[time][dis].length;
                    }
                }
                //因为5时段为空，所以为5赋值为0
                //每个区对应数组的第25位为总和
                let countMax = 0;
                let countMin = 0;
                for (let dis in districtObj) {
                    districtObj[dis][4] = 0;
                    let sum = districtObj[dis].reduce((a, b) => a + b);
                    if (countMax < sum) countMax = sum;
                    if (countMin > sum) countMin = sum;
                    districtObj[dis].push(sum);
                }


                let color = d3.scaleQuantize([countMin, 240], d3.schemeBlues[6]);
                //let path = d3.geoPath();
                const svg = d3.select(".partmap").append("svg")
                    .attr("viewBox", [0, 0, 975, 810]);

                svg.append("g")
                    .attr("transform", "translate(610,20)")
                    .append(() => legend({ color, title: data.title, width: 260 }));

                //Width and height
                var w = 500;
                var h = 300;

                //Define map projection
                var projection = d3.geoMercator()
                    .translate([400, 540])
                    .center([123.310829, 41.795833])
                    .scale([18000]);

                //Define path generator
                var path = d3.geoPath()
                    .projection(projection);

                //Bind data and create one path per GeoJSON feature
                svg.selectAll("path")
                    .data(data.features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .on("click", function(d){
                        console.log("click")
                        document.getElementById("district").innerHTML = d.properties.name
                        document.getElementById("trans").innerHTML = 230
                        document.getElementById("road").innerHTML = "<p>辽宁省沈阳市和平区抚顺路  辽宁省沈阳市和平区哈尔滨路</p><p>辽宁省沈阳市和平区延边街  辽宁省沈阳市和平区桂林街</p>"
                    })
                    .attr("stroke", "black")
                    .style("fill", d => color(districtObj[d.properties.name][24]))
                    .append("title")
                    .text(d => d.properties.name);

                // 绘制折线图
                // 预处理绘制所需的数据结构
                let districtArray = [];
                for (let key in districtObj) {
                    districtObj[key].pop()
                    let value = districtObj[key];
                    districtArray.push({
                        'name': key,
                        'value': value
                    })
                }
                let xArray = [];
                for (let i = 0; i < 24; i++) {
                    xArray.push(i + 1);
                }
                console.log(districtArray)
                let lineheight = 280;
                let linewidth = 580
                let linesvg = d3.select(".densityline").append("svg").style("height", lineheight)
                    .attr("viewBox", [0, 0, linewidth, lineheight])
                // .style("overflow", "visible");
                let linemargin = ({ top: 20, right: 20, bottom: 30, left: 30 })
                let linex = d3.scaleLinear()
                    .domain([1, 24])
                    .range([linemargin.left * 2 - 10, linewidth - linemargin.right])
                let liney = d3.scaleLinear()
                    .domain([0, d3.max(districtArray, d => d3.max(d.value))]).nice()
                    .range([lineheight - linemargin.bottom, linemargin.top])
                let xAxisLine = g => g
                    .attr("transform", `translate(0,${lineheight - linemargin.bottom})`)
                    .call(d3.axisBottom(linex).ticks(8).tickSizeOuter(0))
                let yAxisLine = g => g
                    .attr("transform", `translate(${linemargin.left},0)`)
                    .call(d3.axisLeft(liney))
                    .call(g => g.select(".domain").remove())
                // .call(g => g.select(".tick:last-of-type text").clone()
                //     .attr("x", 3)
                //     .attr("text-anchor", "start")
                //     .attr("font-weight", "bold")
                //     .text(data.y))
                line = d3.line()
                    .defined(d => !isNaN(d))
                    .x((d, i) => linex(i))
                    .y(d => liney(d))
                linesvg.append("g")
                    .call(xAxisLine);

                linesvg.append("g")
                    .call(yAxisLine);

                let linepath = linesvg.append("g")
                    .attr("fill", "none")
                    .attr("stroke", "steelblue")
                    .attr("stroke-width", 1.5)
                    .attr("stroke-linejoin", "round")
                    .attr("stroke-linecap", "round")
                    .selectAll("path")
                    .data(districtArray)
                    .join("path")
                    .style("mix-blend-mode", "multiply")
                    .attr("d", d => line(d.value));

                linesvg.call(hover, path);
                function hover(svg, path) {

                    if ("ontouchstart" in document) svg
                        .style("-webkit-tap-highlight-color", "transparent")
                        .on("touchmove", moved)
                        .on("touchstart", entered)
                        .on("touchend", left)
                    else svg
                        .on("mousemove", moved)
                        .on("mouseenter", entered)
                        .on("mouseleave", left);

                    const dot = svg.append("g")
                        .attr("display", "none");

                    dot.append("circle")
                        .attr("r", 2.5);

                    dot.append("text")
                        .attr("font-family", "sans-serif")
                        .attr("font-size", 10)
                        .attr("text-anchor", "middle")
                        .attr("y", -8);

                    function moved() {
                        d3.event.preventDefault();
                        const mouse = d3.mouse(this);
                        const xm = linex.invert(mouse[0]);
                        const ym = liney.invert(mouse[1]);
                        const i1 = d3.bisectLeft(xArray, xm, 1);
                        const i0 = i1 - 1;
                        const i = xm - xArray[i0] > xArray[i1] - xm ? i1 : i0;
                        //debugger
                        const s = districtArray[i]
                        //const s = d3.least(districtArray, d => Math.abs(d.values[i] - ym));
                        linepath.attr("stroke", d => d === s ? null : "#ddd").filter(d => d === s).raise();
                        dot.attr("transform", `translate(${linex(xArray[i])},${liney(s.value[i])})`);
                        dot.select("text").text(s.name);
                    }

                    function entered() {
                        linepath.style("mix-blend-mode", null).attr("stroke", "#ddd");
                        dot.attr("display", null);
                    }

                    function left() {
                        linepath.style("mix-blend-mode", "multiply").attr("stroke", null);
                        dot.attr("display", "none");
                    }
                }
            })
        })


        //绘制驻点地图
        d3.json("shenyang.json").then(function (data) {
            d3.json("point.json").then(function (points) {
                let maxfrequecy = 0;
                let maxtime = 0;
                let staypoint = points.features;
                let businessArray = []
                let businessTop = []
                let businessMap = new Map();
                //处理得到商圈的信息
                for(let key in staypoint){
                    
                    // console.log(staypoint[key])
                    // console.log(staypoint[key]["properties"])
                    console.log()
                    let business = staypoint[key]["properties"]["business"].split(",")
                    for(let bus of business){
                        if(bus == "") continue;
                        if(!businessMap[bus]){
                            businessMap[bus] = 1;
                        }else{
                            businessMap[bus] = businessMap[bus] + 1;
                        }
                    }
                }
                for(let key in businessMap){
                    businessArray.push({
                        name: key,
                        value: businessMap[key]
                    })
                }
                businessArray.sort((a,b)=> b.value-a.value)
                businessTop = businessArray.slice(0, 8)
                
                staypoint.forEach(d => {
                    maxfrequecy = Math.max(d.properties.frequency, maxfrequecy);
                    maxtime = Math.max(parseInt(d.properties.lastTime), maxtime);
                })
                let color = d3.scaleQuantize([1, maxfrequecy], d3.schemeBlues[6]);
                let colortime = d3.scaleQuantize([0, maxtime], d3.schemeBlues[6]);
                let colorbar = d3.scaleQuantize([0, d3.max(businessTop, d=>d.value)], d3.schemeBlues[8]);

                let coo = function (d) {
                    //获取经纬度
                    let lngLat = d.geometry.coordinates;
                    //转为映射在地图上的坐标
                    let coo = projection(lngLat);
                    return coo;
                }
                //let path = d3.geoPath();
                const svg = d3.select(".staymap").append("svg")
                    .attr("viewBox", [0, 0, 975, 810])
                    .on("click", reset);

                svg.append("g")
                    .attr("transform", "translate(610,20)")
                    .attr("class", "legend")
                    .append(() => legend({ color, title: data.title, width: 260 }))
                    .on("click", trans);
                //用于模拟控制密度的变量
                var i = 0;
                //Width and height
                var w = 500;
                var h = 300;
                const zoom = d3.zoom()
                    .scaleExtent([1, 8])
                    .on("zoom", zoomed);

                //Define map projection
                var projection = d3.geoMercator()
                    .translate([400, 540])
                    .center([123.310829, 41.795833])
                    .scale([18000]);

                //Define path generator
                var path = d3.geoPath()
                    .projection(projection);
                const g = svg.append("g");

                g.selectAll("path")
                    .data(data.features)
                    .enter()
                    .append("path")
                    .on("click", clicked)
                    .attr("d", path)
                    .attr("stroke", "black")
                    .style("fill", 'rgb(211, 211, 211)')
                    .append("title")
                    .text(d => d.properties.name);
                g.selectAll('circle')
                    .data(staypoint)
                    .join('circle')
                    .attr('class', 'point')
                    .attr('cx', function (d) {
                        return coo(d)[0];
                    })
                    .attr('cy', function (d) {
                        return coo(d)[1];
                    })
                    .attr('fill', d => color(+d.properties.frequency)
                    )
                    .attr('r', 4)
                    .on("click", function(d){
                        document.getElementById("point").innerHTML = d.properties.address
                        document.getElementById("frequency").innerHTML = d.properties.frequency
                        document.getElementById("time").innerHTML = parseFloat(d.properties.lastTime).toFixed(1) + "h"
                        document.getElementById("business").innerHTML = d.properties.business
                    })
                    .append("title")
                    .text(d => d.properties.address)
                svg.call(zoom)

                function reset() {
                    svg.transition().duration(750).call(
                        zoom.transform,
                        d3.zoomIdentity,
                        d3.zoomTransform(svg.node()).invert([w / 2, h / 2])
                    );
                }

                function clicked(d) {
                    const [[x0, y0], [x1, y1]] = path.bounds(d);
                    d3.event.stopPropagation();
                    svg.transition().duration(750).call(
                        zoom.transform,
                        d3.zoomIdentity
                            .translate(w / 2, h / 2)
                            .scale(Math.min(8, 0.9 / Math.max((x1 - x0) / w, (y1 - y0) / h)))
                            .translate(-(x0 + x1) / 2, -(y0 + y1) / 2),
                        d3.mouse(svg.node())
                    );
                }

                function zoomed() {
                    const { transform } = d3.event;
                    g.attr("transform", transform);
                    g.attr("stroke-width", 1 / transform.k);
                    g.selectAll("circle")
                        .transition()
                        .duration(750)
                        .attr("r", 4 / transform.k)
                    // console.log(transform)
                    // console.log(transform.k)
                }

                function trans() {
                    d3.select(".legend").remove()
                    svg.append("g")
                        .attr("transform", "translate(610,20)")
                        .attr("class", "legend")
                        .append(() => legend({ colortime, title: data.title, width: 260 }))
                        .on("click", trans);
                    g.selectAll("circle")
                        .transition()
                        .duration(750)
                        .attr("fill", d => colortime(+parseInt(d.properties.lastTime)))
                }

                //绘制热门商圈的条形图
                let margin = ({ top: 30, right: 0, bottom: 10, left: 30 })
                let height = 280
            let bartimewidth = 568
            const bartimesvg = d3.select(".business").append("svg")
                .attr("viewBox", [0, 0, bartimewidth, height]);
            let bartimex = d3.scaleBand()
                .domain(businessTop.map(d => d.name))
                .range([margin.left, bartimewidth - margin.right])
                .padding(0.1)
            

            let bartimey = d3.scaleLinear()
                .domain([0, d3.max(businessTop, d => d.value)]).nice()
                .range([height - margin.bottom - 10, margin.top])
                console.log(bartimey.domain())
            let xAxisbartime = g => g
                .attr("transform", `translate(0,${height - margin.bottom - 10})`)
                .call(d3.axisBottom(bartimex).tickSizeOuter(0))
            let yAxisbartime = g => g
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(bartimey))
                .call(g => g.select(".domain").remove())
                .call(g => g.append("text")
                    .attr("x", -margin.left)
                    .attr("y", 10)
                    .attr("fill", "currentColor")
                    .attr("text-anchor", "start")
                    .text(businessTop.name))

            bartimesvg.append("g")
                .attr("fill", "steelblue")
                .selectAll("rect")
                .data(businessTop)
                .join("rect")
                .attr("x", (d, i) => bartimex(d.name))
                .attr("y", d => bartimey(d.value))
                .attr("height", d => bartimey(0) - bartimey(d.value))
                .attr("width", bartimex.bandwidth())
                .attr("fill", d => colorbar(d.value));

            bartimesvg.append("g")
                .call(xAxisbartime);

            bartimesvg.append("g")
                .call(yAxisbartime);
            })
        })


    </script>
</body>

</html>